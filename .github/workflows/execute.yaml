name: Execute Notebook

on:
  workflow_call:
  workflow_run:
    workflows: ["Build and push container image"]
    branches: main
    types:
      - completed

# This job installs dependencies, build the jupyter notebook, and pushes it to `render`, a new `branch`
jobs:
  execute:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    if: github.repository_owner == 'eds-book'
    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-latest"]
    defaults:
      run:
        shell: bash -l {0}
    steps:
      - name: Checkout files in repo
        uses: actions/checkout@main
      - name: Fetch myst.yml file
        uses: ndelangen/action-read-yaml@1.1.0
        id: read_action_js
        with:
          config: ${{ github.workspace }}/myst.yml
      - name: Run the build process with Docker
        uses: addnab/docker-run-action@v3
        with:
            image: quay.io/${{ steps.read_action_js.outputs['project.id'] }}:latest
            options: --user root -v ${{ github.workspace }}:/tmp
            shell: bash
            run: |
                v=$(jupyter kernelspec list | awk '{print $1}' | egrep ${{ steps.read_action_js.outputs['project.jupyter.binder.kernelName'] }})
                jupyter-nbconvert --to notebook --ExecutePreprocessor.kernel_name="$v" --inplace --execute ${{ steps.read_action_js.outputs['project.toc.0.file'] }}
                cp ${{ steps.read_action_js.outputs['project.toc.0.file' ]}}  /tmp
      - name: Commit
        run: |
          ls
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add ${{ steps.read_action_js.outputs['project.toc.0.file'] }}
          git commit -m 'update'
      - name: Push
        uses: ad-m/github-push-action@master
        with:
         github_token: ${{ secrets.GITHUB_TOKEN }}
         branch: render
         force: true